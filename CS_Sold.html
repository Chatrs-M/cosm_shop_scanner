<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - é”€å”®å½•å…¥</title>
<meta name="robots" content="noindex, nofollow">

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
body{
  margin:0;
  background:linear-gradient(180deg,#fff5f8 0%,#ffeaf1 100%);
  color:#d63384;
  font-family:"Segoe UI","Microsoft YaHei",sans-serif;
  text-align:center;
}
h2{margin-top:16px;color:#d63384;}

#scanner-container{
  position:relative;
  width:90vw;
  height:45vh;
  margin:20px auto;
  border:2px solid rgba(255,105,180,0.4);
  border-radius:12px;
  box-shadow:0 0 10px rgba(255,182,193,0.6);
  overflow:hidden;
}

video{width:100%;height:100%;object-fit:cover;}

.corner{position:absolute;width:30px;height:30px;border:3px solid #ff69b4;}
.top-left{top:0;left:0;border-right:none;border-bottom:none;}
.top-right{top:0;right:0;border-left:none;border-bottom:none;}
.bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
.bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

.center-line{
  position:absolute;
  top:50%;
  left:0;
  width:100%;
  height:2px;
  background-color:#ff69b4;
  transform:translateY(-50%);
}

#result{font-size:1.3em;margin:20px 0;font-weight:600;}

button{
  padding:10px 18px;
  font-size:16px;
  background:#d63384;
  color:white;
  border:none;
  border-radius:8px;
  margin:6px;
}
</style>
</head>

<body>

<h2>é”€å”®å½•å…¥æ‰«ç </h2>

<div id="scanner-container">
  <video></video>
  <div class="corner top-left"></div>
  <div class="corner top-right"></div>
  <div class="corner bottom-left"></div>
  <div class="corner bottom-right"></div>
  <div class="center-line"></div>
</div>

<div id="result">ç­‰å¾…æ‰«æä¸­...</div>

<button id="flash-btn">ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰</button>

<audio id="beep-sound"
src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
preload="auto"></audio>

<script>
/* ===== AppSheet ===== */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view  = "Order Comfirm_Form";

/* ===== æ‰«ç è§„åˆ™ ===== */
const REG = /^[A-Z0-9-]+$/;
const LEN = 8;
const CONFIRM = 2;
const THROTTLE = 30000;

/* ===== çŠ¶æ€ ===== */
let lastCode = null;
let stableCount = 0;
let lastSuccess = 0;
let frozen = false;

/* ===== DOM ===== */
const result = document.getElementById("result");
const beep   = document.getElementById("beep-sound");
const flashBtn = document.getElementById("flash-btn");

/* ===== é—ªå…‰ç¯ ===== */
let track = null;
let flashOn = false;

flashBtn.onclick = async ()=>{
  if(!track){
    alert("æ‘„åƒå¤´æœªå°±ç»ª");
    return;
  }

  const cap = track.getCapabilities();
  if(!cap.torch){
    alert("è¯¥è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯");
    return;
  }

  flashOn = !flashOn;
  await track.applyConstraints({ advanced:[{ torch: flashOn }] });
  flashBtn.innerText = flashOn ? "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå¼€å¯ï¼‰" : "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰";
};

/* ===== æ ¡éªŒé€»è¾‘ ===== */
function process(code){
  if(frozen) return;
  if(!REG.test(code)) return;
  if(code.length !== LEN) return;

  if(code === lastCode){
    stableCount++;
  }else{
    lastCode = code;
    stableCount = 1;
  }

  if(stableCount < CONFIRM) return;
  if(Date.now() - lastSuccess < THROTTLE) return;

  frozen = true;
  lastSuccess = Date.now();
  success(code);
}

/* ===== æ‘„åƒå¤´ ===== */
Quagga.init({
  inputStream:{
    type:"LiveStream",
    target:document.querySelector("#scanner-container"),
    constraints:{ facingMode:"environment" },
    area:{
      top:"35%",
      bottom:"35%",
      left:"15%",
      right:"15%"
    }
  },
  decoder:{ readers:["code_128_reader"] },
  locate:true
}, err=>{
  if(err){
    result.innerText="æ— æ³•å¯åŠ¨æ‘„åƒå¤´";
    return;
  }
  Quagga.start();
  result.innerText="è¯·å°†æ¡ç ç½®äºç²‰è‰²æ¡†å†…æ‰«æ...";

  const video = document.querySelector("video");
  if(video.srcObject){
    track = video.srcObject.getVideoTracks()[0];
  }
});

Quagga.onDetected(res=>{
  if(res.codeResult?.code){
    process(res.codeResult.code);
  }
});

/* ===== æˆåŠŸå¤„ç† ===== */
function success(code){
  beep.currentTime = 0;
  beep.play().catch(()=>{});
  result.innerText = "è¯†åˆ«æˆåŠŸï¼š" + code;

  Quagga.stop(); // å†»ç»“ç”»é¢

  const encoded = encodeURIComponent(JSON.stringify({ BarCode: code }));
  const appURL = `appsheet://app?appId=${appId}#view=${view}&defaults=${encoded}`;
  const webURL = `https://www.appsheet.com/start/${appId}#view=${view}&defaults=${encoded}`;

  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = appURL;
  document.body.appendChild(iframe);

  setTimeout(()=>window.location.href = webURL, 500);
}
</script>

</body>
</html>
