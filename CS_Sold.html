<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - 销售录入</title>
<meta name="robots" content="noindex, nofollow">

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
body{
  margin:0;
  background:linear-gradient(180deg,#fff5f8 0%,#ffeaf1 100%);
  color:#d63384;
  font-family:"Segoe UI","Microsoft YaHei",sans-serif;
  text-align:center;
}
h2{margin-top:16px;color:#d63384;}

#scanner-container{
  position:relative;
  width:90vw;
  height:45vh;
  margin:20px auto;
  border:2px solid rgba(255,105,180,0.4);
  border-radius:12px;
  box-shadow:0 0 10px rgba(255,182,193,0.6);
  overflow:hidden;
}

video{width:100%;height:100%;object-fit:cover;}

.corner{position:absolute;width:30px;height:30px;border:3px solid #ff69b4;}
.top-left{top:0;left:0;border-right:none;border-bottom:none;}
.top-right{top:0;right:0;border-left:none;border-bottom:none;}
.bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
.bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

.center-line{
  position:absolute;
  top:50%;
  left:0;
  width:100%;
  height:2px;
  background-color:#ff69b4;
  transform:translateY(-50%);
}

#result{font-size:1.3em;margin:20px 0;font-weight:600;}
</style>
</head>

<body>

<h2>销售录入扫码</h2>

<div id="scanner-container">
  <video></video>
  <div class="corner top-left"></div>
  <div class="corner top-right"></div>
  <div class="corner bottom-left"></div>
  <div class="corner bottom-right"></div>
  <div class="center-line"></div>
</div>

<div id="result">等待扫描中...</div>

<audio id="beep-sound"
src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
preload="auto"></audio>

<script>
/* ===== AppSheet ===== */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view  = "Order Comfirm_Form";

/* ===== 扫码规则 ===== */
const REG = /^[A-Z0-9-]+$/;
const LEN = 8;
const CONFIRM = 2;
const THROTTLE = 30000;

/* ===== 状态 ===== */
let lastCode = null;
let stableCount = 0;
let lastSuccess = 0;
let frozen = false;

/* ===== DOM ===== */
const result = document.getElementById("result");
const beep   = document.getElementById("beep-sound");

/* ===== 校验逻辑 ===== */
function process(code){
  if(frozen) return;

  if(!REG.test(code)) return;
  if(code.length !== LEN) return;

  if(code === lastCode){
    stableCount++;
  }else{
    lastCode = code;
    stableCount = 1;
  }

  if(stableCount < CONFIRM) return;

  if(Date.now() - lastSuccess < THROTTLE) return;

  frozen = true;
  lastSuccess = Date.now();
  success(code);
}

/* ===== 摄像头 ===== */
Quagga.init({
  inputStream:{
    type:"LiveStream",
    target:document.querySelector("#scanner-container"),
    constraints:{ facingMode:"environment" },
    area:{              // 中央扫描区域
      top:"35%",
      bottom:"35%",
      left:"15%",
      right:"15%"
    }
  },
  decoder:{ readers:["code_128_reader"] },
  locate:true
}, err=>{
  if(err){
    result.innerText="无法启动摄像头";
    return;
  }
  Quagga.start();
  result.innerText="请将条码置于粉色框内扫描...";
});

Quagga.onDetected(res=>{
  if(res.codeResult?.code){
    process(res.codeResult.code);
  }
});

/* ===== 成功处理 ===== */
function success(code){
  beep.currentTime = 0;
  beep.play().catch(()=>{});
  result.innerText = "识别成功：" + code;

  Quagga.stop(); // 冻结

  const encoded = encodeURIComponent(JSON.stringify({ BarCode: code }));
  const appURL = `appsheet://app?appId=${appId}#view=${view}&defaults=${encoded}`;
  const webURL = `https://www.appsheet.com/start/${appId}#view=${view}&defaults=${encoded}`;

  const iframe = document.createElement("iframe");
  iframe.style.display = "none";
  iframe.src = appURL;
  document.body.appendChild(iframe);

  setTimeout(()=>window.location.href = webURL, 500);
}
</script>

</body>
</html>
