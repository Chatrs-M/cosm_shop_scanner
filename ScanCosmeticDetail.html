<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - é”€å”®å½•å…¥</title>
<meta name="robots" content="noindex, nofollow">

<!-- ğŸ”§ å¿…é¡»æ·»åŠ  polyfill æ‰èƒ½ç¡®ä¿ Firefox + Edge æ­£å¸¸ -->
<script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@8.2.3/out/adapter.js"></script>

<!-- Quagga2 CDNï¼ˆå…¼å®¹ Firefox çš„ç¨³å®šç‰ˆæœ¬ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.2.7/dist/quagga.min.js"></script>

<style>
  body{
    margin:0;background:linear-gradient(180deg,#fff5f8 0%,#ffeaf1 100%);
    color:#d63384;font-family:"Segoe UI","Microsoft YaHei",sans-serif;text-align:center;
  }
  h2{margin-top:16px;color:#d63384;}

  #scanner-container{
    position:relative;width:90vw;height:45vh;margin:20px auto;
    border:2px solid rgba(255,105,180,0.4);border-radius:12px;
    box-shadow:0 0 10px rgba(255,182,193,0.6);overflow:hidden;
  }
  video{width:100%;height:100%;object-fit:cover;}

  .corner{position:absolute;width:30px;height:30px;border:3px solid #ff69b4;}
  .top-left{top:0;left:0;border-right:none;border-bottom:none;}
  .top-right{top:0;right:0;border-left:none;border-bottom:none;}
  .bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
  .bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

  .center-line{
    position:absolute;top:50%;left:0;width:100%;height:2px;
    background-color:#ff69b4;transform:translateY(-50%);
  }

  #result{font-size:1.3em;margin:20px 0;font-weight:600;}
</style>
</head>

<body>
<h2>é”€å”®å½•å…¥æ‰«ç </h2>

<div id="scanner-container">
  <video id="video"></video>

  <div class="corner top-left"></div>
  <div class="corner top-right"></div>
  <div class="corner bottom-left"></div>
  <div class="corner bottom-right"></div>
  <div class="center-line"></div>
</div>

<div id="result">ç­‰å¾…æ‰«æä¸­...</div>

<audio id="beep-sound"
       src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
       preload="auto"></audio>

<script>
/* ========== åŸºæœ¬å‚æ•° ========== */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view = "Order Comfirm_Form";
let lastCode = "";

/* ========== å¯åŠ¨ Quagga æ‰«æ ========== */
function startScanner() {

    // Firefox å¿…é¡»æŒ‡å®š exact æ‰èƒ½å¼ºåˆ¶è°ƒç”¨åæ‘„åƒå¤´
    const constraints = {
        facingMode: { ideal: "environment" }
    };

    Quagga.init(
        {
            inputStream: {
                type: "LiveStream",
                target: document.querySelector("#scanner-container"),
                constraints: constraints
            },
            decoder: {
                readers: ["code_128_reader"] // é€‚åˆä½ çš„æ¡ç 
            },
            locate: true,                // æé«˜ Firefox è¯†åˆ«ç‡
            numOfWorkers: 2,             // Web Worker çº¿ç¨‹
            frequency: 10                // æ‰«æé¢‘ç‡
        },
        err => {
            if (err) {
                document.getElementById("result").innerText = "æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼š" + err;
                console.error(err);
                return;
            }

            Quagga.start();
            document.getElementById("result").innerText = "è¯·å°†æ¡ç ç½®äºç²‰è‰²æ¡†å†…æ‰«æ...";
        }
    );

    /* ========== æ¡ç è¯†åˆ«æˆåŠŸå›è°ƒ ========== */
    Quagga.onDetected(res => {
        const code = res.codeResult.code;
        if (code && code !== lastCode) {
            lastCode = code;

            document.getElementById("result").innerText = "è¯†åˆ«æˆåŠŸï¼š" + code;

            /* å£°éŸ³æé†’ */
            const beep = document.getElementById("beep-sound");
            beep.currentTime = 0;
            beep.play().catch(()=>{});

            /* éœ‡åŠ¨æé†’ï¼ˆEdge / Chrome / Firefox Android æ”¯æŒï¼‰ */
            if (navigator.vibrate) navigator.vibrate(200);

            /* æ‰“å¼€ AppSheet */
            openAppSheet(view, code);
        }
    });
}

/* ========== æ‰“å¼€ AppSheet ========== */
function openAppSheet(view, code) {

    // ä½ åŸæ¥çš„ä¼ é€’æ–¹å¼ä¿ç•™
    const encoded = encodeURIComponent(`{"Code":"${code}"}`);

    const appURL = `appsheet://app?appId=${appId}#view=${view}&defaults=${encoded}`;
    const webURL = `https://www.appsheet.com/start/${appId}#view=${view}&defaults=${encoded}`;

    // App å†…è·³è½¬
    const iframe = document.createElement("iframe");
    iframe.style.display = "none";
    iframe.src = appURL;
    document.body.appendChild(iframe);

    // æµè§ˆå™¨è·³è½¬ï¼ˆç¨å¾®å»¶è¿Ÿï¼‰
    setTimeout(() => window.location.href = webURL, 1200);
}

/* ========== è‡ªåŠ¨å¯åŠ¨æ‘„åƒå¤´ ========== */
startScanner();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Batch Scanner</title>

<!-- å®˜æ–¹ CDNï¼šç¡®ä¿ GitHub Pages å¯ç”¨ -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 15px;
        background: #fff;
    }
    #reader {
        width: 100%;
        max-width: 400px;
        margin: auto;
    }
    #resultBox {
        margin-top: 20px;
        padding: 10px;
        border: 2px solid #888;
        border-radius: 10px;
        background: #f8f8f8;
        font-size: 20px;
        text-align: center;
    }
    button {
        margin-top: 20px;
        width: 100%;
        padding: 15px;
        font-size: 20px;
        border: none;
        border-radius: 8px;
        background: #4CAF50;
        color: white;
    }
</style>
</head>

<body>
<h2>Scan Batch Code</h2>

<div id="reader"></div>

<div id="resultBox">Waiting for scan...</div>

<button id="confirmBtn">ç¡®è®¤å¹¶æ‰“å¼€ AppSheet</button>

<script>
let scannedCode = "";
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const viewName = "Batches_Detail";

// åˆå§‹åŒ–æ‰«æå™¨
function startScanner() {
    const html5QrCode = new Html5Qrcode("reader");

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };

    html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
            scannedCode = decodedText.trim();
            document.getElementById("resultBox").innerText = "Scanned: " + scannedCode;
        },
        (errorMessage) => {}
    ).catch(err => {
        document.getElementById("resultBox").innerText =
            "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼š" + err;
    });
}

// æŒ‰ä¸‹ç¡®è®¤æŒ‰é’® â†’ è·³ AppSheet Detail
document.getElementById("confirmBtn").onclick = function () {
    if (!scannedCode) {
        alert("è¯·å…ˆæ‰«ææ¡ç ï¼");
        return;
    }

    const url = `https://www.appsheet.com/start/${appId}#control=${viewName}&row=${scannedCode}`;
    window.location.href = url;
};

// ç«‹å³å¯åŠ¨æ‘„åƒå¤´
startScanner();
</script>
</body>
</html>

