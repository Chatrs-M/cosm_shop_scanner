<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    video { width: 100%; max-width: 400px; border: 2px solid #ccc; border-radius: 10px; }
    button { padding: 10px 16px; margin: 10px 5px; font-size: 16px; }
    #msg { margin-top: 15px; color: #d00; font-weight: bold; }
</style>
</head>
<body>

<h2>商品扫码系统</h2>

<video id="preview" autoplay playsinline></video>

<br>
<button id="btnScan">扫描二维码</button>
<button id="btnFlash">开灯</button>

<div id="msg"></div>

<!-- 内置提示音（base64） -->
<audio id="beep">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
// --- 摄像头相关 ---
let video = document.getElementById("preview");
let btnScan = document.getElementById("btnScan");
let btnFlash = document.getElementById("btnFlash");
let msgBox = document.getElementById("msg");
let beep = document.getElementById("beep");

let stream = null;
let track = null;
let flashOn = false;       // 默认关闭闪光灯
let lastDecodeTime = 0;    // 30 秒扫描一次

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = stream;
        track = stream.getVideoTracks()[0];
        msgBox.textContent = "摄像头已启动";
    } catch (err) {
        msgBox.textContent = "无法使用摄像头: " + err.message;
    }
}
startCamera();

// --- 闪光灯开关 ---
async function toggleFlash() {
    if (!track) return;

    const capabilities = track.getCapabilities();
    if (!capabilities.torch) {
        msgBox.textContent = "此设备不支持闪光灯";
        return;
    }

    flashOn = !flashOn;
    try {
        await track.applyConstraints({
            advanced: [{ torch: flashOn }]
        });
        btnFlash.textContent = flashOn ? "关灯" : "开灯";
    } catch (err) {
        msgBox.textContent = "闪光灯操作失败: " + err.message;
    }
}
btnFlash.onclick = toggleFlash;

// --- 扫描二维码 ---
btnScan.onclick = async () => {
    const now = Date.now();

    // 限制 30 秒扫描一次
    if (now - lastDecodeTime < 30000) {
        msgBox.textContent = "请等待 30 秒后再扫描。";
        return;
    }

    msgBox.textContent = "解析中，请稍候…";

    try {
        // 抓取一帧画面
        let canvas = document.createElement("canvas");
        let ctx = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let qr = jsQR(imageData.data, canvas.width, canvas.height);

        if (!qr) {
            msgBox.textContent = "无法识别二维码，请调整光线或距离";
            return;
        }

        lastDecodeTime = now;

        let code = qr.data.trim();
        msgBox.textContent = "解析成功：" + code;

        // --- 播放提示音 ---
        beep.currentTime = 0;
        beep.play().catch(() => {});

        // --- 跳转至 AppSheet 详情页 ---
        window.location.href =
            "https://www.appsheet.com/start/YOUR_APP_ID#control=Detail&row=" +
            encodeURIComponent(code);

    } catch (err) {
        msgBox.textContent = "解析时发生错误: " + err.message;
    }
};
</script>

</body>
</html>
