<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>条码快速扫描器</title>

<!-- Quagga2 条码识别库 -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
  body {
    margin: 0;
    background-color: #000;
    color: #0f0;
    font-family: "Segoe UI", sans-serif;
    text-align: center;
  }
  #scanner-container {
    position: relative;
    width: 90vw;
    height: 45vh; /* 小一半扫描窗口 */
    margin: 20px auto;
    overflow: hidden;
    border: 2px solid rgba(0,255,0,0.3);
    border-radius: 12px;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  /* 四角边框 */
  .corner {
    position: absolute;
    width: 30px;
    height: 30px;
    border: 3px solid #00ff00;
  }
  .top-left { top: 0; left: 0; border-right: none; border-bottom: none; }
  .top-right { top: 0; right: 0; border-left: none; border-bottom: none; }
  .bottom-left { bottom: 0; left: 0; border-right: none; border-top: none; }
  .bottom-right { bottom: 0; right: 0; border-left: none; border-top: none; }

  /* 中间水平线（固定） */
  .center-line {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #00ff00;
    transform: translateY(-50%);
  }

  #result {
    font-size: 1.3em;
    margin: 20px 0;
  }

  button {
    display: block;
    width: 85%;
    margin: 10px auto;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    color: #fff;
    font-weight: 600;
  }
  #btnProc { background-color: #00b050; }
  #btnSales { background-color: #0070c0; }
  #btnDetail { background-color: #e67e22; }
</style>
</head>

<body>
  <h2>条码快速扫描器</h2>

  <div id="scanner-container">
    <video id="video"></video>
    <div class="corner top-left"></div>
    <div class="corner top-right"></div>
    <div class="corner bottom-left"></div>
    <div class="corner bottom-right"></div>
    <div class="center-line"></div>
  </div>

  <div id="result">等待扫描中...</div>

  <button id="btnProc">🟢 购货录入</button>
  <button id="btnSales">🔵 销售录入</button>
  <button id="btnDetail">🟠 查看详情</button>

  <script>
    let lastCode = "";

    function startScanner() {
      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: document.querySelector("#scanner-container"),
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["code_128_reader"]
        }
      }, function(err) {
        if (err) {
          console.error(err);
          document.getElementById('result').innerText = "无法启动摄像头，请检查权限";
          return;
        }
        Quagga.start();
        document.getElementById('result').innerText = "请将条码置于绿色框内扫描...";
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        if (code && code !== lastCode) {
          lastCode = code;
          document.getElementById('result').innerText = "识别成功： " + code;
        }
      });
    }

    function encodeURL(view, code) {
      const appId = "c2893944-c589-4385-833c-17a86cc10826";
      const encoded = encodeURIComponent(`{"Code":"${code}"}`);
      return `https://www.appsheet.com/start/${appId}#view=${view}&defaults=${encoded}`;
    }

    document.getElementById("btnProc").addEventListener("click", function() {
      if (!lastCode) return alert("请先扫描条码");
      window.location.href = encodeURL("Procurment_Form", lastCode);
    });
    document.getElementById("btnSales").addEventListener("click", function() {
      if (!lastCode) return alert("请先扫描条码");
      window.location.href = encodeURL("Sales_Form", lastCode);
    });
    document.getElementById("btnDetail").addEventListener("click", function() {
      if (!lastCode) return alert("请先扫描条码");
      window.location.href = encodeURL("Procurment_Detail", lastCode);
    });

    startScanner();
  </script>
</body>
</html>
