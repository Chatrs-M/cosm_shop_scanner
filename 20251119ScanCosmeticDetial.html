<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - æ‰¹æ¬¡è¯¦æƒ…</title>
<meta name="robots" content="noindex, nofollow">

<!-- Quagga -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<!-- Cropper -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
body{
    margin:0;
    background:linear-gradient(180deg,#fff5f8,#ffeaf1);
    color:#d63384;
    font-family:"Segoe UI","Microsoft YaHei",sans-serif;
    text-align:center;
}
h2{margin-top:16px;}

#scanner-container{
    position:relative;
    width:90vw;height:45vh;
    margin:20px auto;
    border:2px solid rgba(255,105,180,.4);
    border-radius:12px;
    overflow:hidden;
}
video{width:100%;height:100%;object-fit:cover;}

.corner{position:absolute;width:30px;height:30px;border:3px solid #ff69b4;}
.top-left{top:0;left:0;border-right:none;border-bottom:none;}
.top-right{top:0;right:0;border-left:none;border-bottom:none;}
.bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
.bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

#image-layer{
    display:none;
}

#image-wrapper{
    width:90vw;
    max-width:420px;
    margin:10px auto;
    position:relative;   /* â­å…³é”®ï¼šCropper å¿…é¡» */
}

#scan-image{
    width:100%;
    display:block;
    border-radius:12px;
}

#image-actions{
    margin-top:12px;
    display:flex;
    justify-content:center;
    gap:12px;
    position:relative;
    z-index:20;
}

#result{font-weight:600;margin:12px;}

button{
    padding:10px 18px;
    font-size:16px;
    margin:6px;
    background:#d63384;
    color:white;
    border:none;
    border-radius:8px;
    touch-action:manipulation;
}

#toast{
    position:fixed;
    top:16px;
    right:16px;
    background:rgba(214,51,132,.9);
    color:white;
    padding:8px 12px;
    border-radius:8px;
    opacity:0;
    transition:opacity .4s;
    z-index:9999;
}
</style>
</head>

<body>

<h2>æ‰¹æ¬¡è¯¦æƒ…æ‰«ç </h2>

<!-- æ‘„åƒå¤´ -->
<div id="scanner-container">
    <video></video>
    <div class="corner top-left"></div><div class="corner top-right"></div>
    <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
</div>

<!-- ç›¸å†Œè£å‰ª -->
<div id="image-layer">
    <div id="image-wrapper">
        <img id="scan-image">
    </div>
    <div id="image-actions">
        <button id="confirm-image-scan">âœ” è¯†åˆ«é€‰ä¸­åŒºåŸŸ</button>
        <button id="cancel-image-scan">â†© è¿”å›æ‘„åƒå¤´</button>
    </div>
</div>

<div id="result">ç­‰å¾…æ‰«æä¸­...</div>

<div style="display:flex;justify-content:center;gap:10px;">
    <button id="flash-btn">ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰</button>
    <button id="gallery-btn">ğŸ–¼ ä»ç›¸å†Œè¯†åˆ«</button>
</div>

<input type="file" id="image-input" accept="image/*" style="display:none">
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<div id="toast"></div>

<script>
/* ========= AppSheet ========= */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view = "Batchs_Detail";

/* ========= è°ƒè¯• ========= */
const DEBUG = new URLSearchParams(location.search).get("debug")==="1";
const toast = document.getElementById("toast");
function showToast(t){
    if(!DEBUG) return;
    toast.innerText=t;
    toast.style.opacity=1;
    setTimeout(()=>toast.style.opacity=0,1200);
}

/* ========= è§„åˆ™ ========= */
const REG=/^[A-Z0-9-]+$/;
const LEN=8, CONFIRM=2, THROTTLE=30000;
let last=null,count=0,lastOK=0;

/* ========= DOM ========= */
const scanner=document.getElementById("scanner-container");
const imageLayer=document.getElementById("image-layer");
const scanImage=document.getElementById("scan-image");
const flashBtn=document.getElementById("flash-btn");
const galleryBtn=document.getElementById("gallery-btn");
const imageInput=document.getElementById("image-input");
const confirmBtn=document.getElementById("confirm-image-scan");
const cancelBtn=document.getElementById("cancel-image-scan");
const result=document.getElementById("result");
const beep=document.getElementById("beep");

/* ========= æ ¡éªŒ ========= */
function process(code){
    if(!REG.test(code)) return showToast("éæ³•å­—ç¬¦");
    if(code.length!==LEN) return showToast("é•¿åº¦ä¸ç¬¦");
    if(code===last){count++;}else{last=code;count=1;}
    if(count<CONFIRM) return showToast("ä¸ç¨³å®š");
    if(Date.now()-lastOK<THROTTLE) return showToast("å·²æ‰«è¿‡");
    lastOK=Date.now(); last=null; count=0;
    success(code);
}

/* ========= ç›¸æœº ========= */
let track=null,flash=false;
Quagga.init({
    inputStream:{type:"LiveStream",target:scanner,constraints:{facingMode:"environment"}},
    decoder:{readers:["code_128_reader"]},
    locate:true
},err=>{
    if(err){result.innerText="æ— æ³•å¯åŠ¨æ‘„åƒå¤´";return;}
    Quagga.start();
    const v=scanner.querySelector("video");
    if(v.srcObject) track=v.srcObject.getVideoTracks()[0];
});
Quagga.onDetected(r=>r.codeResult&&process(r.codeResult.code));

flashBtn.onclick=async()=>{
    if(!track) return alert("æ‘„åƒå¤´æœªå°±ç»ª");
    const c=track.getCapabilities();
    if(!c.torch) return alert("ä¸æ”¯æŒé—ªå…‰ç¯");
    flash=!flash;
    await track.applyConstraints({advanced:[{torch:flash}]});
    flashBtn.innerText=flash?"ğŸ”¦ é—ªå…‰ç¯ï¼ˆå¼€å¯ï¼‰":"ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰";
};

/* ========= ç›¸å†Œ ========= */
let cropper=null;
const reader=new ZXing.BrowserBarcodeReader();

galleryBtn.onclick=()=>imageInput.click();

imageInput.onchange=e=>{
    const f=e.target.files[0];
    if(!f) return;
    scanner.style.display="none";
    imageLayer.style.display="block";
    if(cropper){cropper.destroy();cropper=null;}
    scanImage.src=URL.createObjectURL(f);
    scanImage.onload=()=>{
        requestAnimationFrame(()=>{
            cropper=new Cropper(scanImage,{
                viewMode:1,
                autoCropArea:0.85,
                dragMode:"move",
                background:false,
                responsive:true
            });
        });
    };
};

confirmBtn.onclick=()=>{
    if(!cropper) return;
    const c=cropper.getCroppedCanvas();
    reader.decodeFromImage(undefined,c.toDataURL())
        .then(r=>process(r.text))
        .catch(()=>result.innerText="æœªè¯†åˆ«åˆ°æ¸…æ™°æ¡ç ");
};

cancelBtn.onclick=()=>{
    cropper?.destroy();
    imageLayer.style.display="none";
    scanner.style.display="block";
};

/* ========= æˆåŠŸ ========= */
function success(code){
    beep.play().catch(()=>{});
    result.innerText="è¯†åˆ«æˆåŠŸï¼š"+code;
    const app=`appsheet://app?appId=${appId}#view=${view}&row=${encodeURIComponent(code)}`;
    const web=`https://www.appsheet.com/start/${appId}#view=${view}&row=${encodeURIComponent(code)}`;
    const i=document.createElement("iframe");
    i.style.display="none"; i.src=app; document.body.appendChild(i);
    setTimeout(()=>location.href=web,1200);
}
</script>

</body>
</html>
