<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - æ‰¹æ¬¡è¯¦æƒ…</title>
<meta name="robots" content="noindex, nofollow">

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<style>
body{
    margin:0;
    background:linear-gradient(180deg,#fff5f8,#ffeaf1);
    color:#d63384;
    font-family:"Segoe UI","Microsoft YaHei",sans-serif;
    text-align:center;
}
h2{margin-top:16px;}

#scanner-container{
    position:relative;
    width:90vw;height:45vh;
    margin:20px auto;
    border:2px solid rgba(255,105,180,.4);
    border-radius:12px;
    overflow:hidden;
}
video{width:100%;height:100%;object-fit:cover;}

.corner{position:absolute;width:30px;height:30px;border:3px solid #ff69b4;}
.top-left{top:0;left:0;border-right:none;border-bottom:none;}
.top-right{top:0;right:0;border-left:none;border-bottom:none;}
.bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
.bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

#image-layer{display:none;}
#image-wrapper{width:90vw;max-width:420px;margin:10px auto;}
#scan-image{width:100%;border-radius:12px;}

#result{font-weight:600;margin:12px;}

button{
    padding:10px 18px;
    font-size:16px;
    margin:6px;
    background:#d63384;
    color:white;
    border:none;
    border-radius:8px;
}

#toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(214,51,132,0.9);
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    font-weight: bold;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    z-index: 9999;
}
</style>
</head>

<body>

<h2>æ‰¹æ¬¡è¯¦æƒ…æ‰«ç </h2>

<div id="scanner-container">
    <video></video>
    <div class="corner top-left"></div><div class="corner top-right"></div>
    <div class="corner bottom-left"></div><div class="corner bottom-right"></div>
</div>

<div id="image-layer">
    <div id="image-wrapper">
        <img id="scan-image">
    </div>
    <button id="confirm-image-scan">âœ” è¯†åˆ«é€‰ä¸­åŒºåŸŸ</button>
    <button id="cancel-image-scan">â†© è¿”å›æ‘„åƒå¤´</button>
</div>

<div id="result">ç­‰å¾…æ‰«æä¸­...</div>

<div style="display:flex;justify-content:center;gap:10px;">
    <button id="flash-btn">ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰</button>
    <button id="gallery-btn">ğŸ–¼ ä»ç›¸å†Œè¯†åˆ«</button>
</div>

<input type="file" id="image-input" accept="image/*" style="display:none">
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div id="toast"></div>

<script>
/* ===== AppSheet é…ç½® ===== */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view = "Batchs_Detail";

/* ===== è°ƒè¯•æ¨¡å¼ ===== */
const DEBUG = new URLSearchParams(location.search).get("debug") === "1";
const debugStats = {invalidChar:0, invalidLength:0, unstable:0, throttled:0};
const toastEl = document.getElementById("toast");
function showToast(msg){
    toastEl.innerText = msg;
    toastEl.style.opacity = "1";
    setTimeout(()=>{toastEl.style.opacity="0";}, 1500);
}
function debugLog(reason){
    if(!DEBUG) return;
    debugStats[reason]++;
    showToast("ä¸¢å¼ƒåŸå› ï¼š" + reason);
    console.table(debugStats);
}

/* ===== æ‰«ç è§„åˆ™ ===== */
const VALID_CODE_REGEX = /^[A-Z0-9-]+$/;
const CODE_LENGTH = 8;
const CONFIRM_COUNT = 2;
const SCAN_THROTTLE = 30000;

let lastCode = null;
let sameCount = 0;
let lastAccepted = 0;

/* ===== å…ƒç´ ç»‘å®š ===== */
const flashBtn = document.getElementById("flash-btn");
const galleryBtn = document.getElementById("gallery-btn");
const imageInput = document.getElementById("image-input");
const confirmImageScan = document.getElementById("confirm-image-scan");
const cancelImageScan = document.getElementById("cancel-image-scan");
const scannerContainer = document.getElementById("scanner-container");
const imageLayer = document.getElementById("image-layer");
const scanImage = document.getElementById("scan-image");
const result = document.getElementById("result");
const beep = document.getElementById("beep");

/* ===== æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ ===== */
function processScanResult(code){
    if(!VALID_CODE_REGEX.test(code)){ debugLog("invalidChar"); return; }
    if(code.length !== CODE_LENGTH){ debugLog("invalidLength"); return; }
    if(code === lastCode){ sameCount++; } else { lastCode = code; sameCount = 1; }
    if(sameCount < CONFIRM_COUNT){ debugLog("unstable"); return; }
    const now = Date.now();
    if(now - lastAccepted < SCAN_THROTTLE){ debugLog("throttled"); return; }

    // é€šè¿‡éªŒè¯
    lastAccepted = now;
    lastCode = null;
    sameCount = 0;
    handleSuccess(code);
}

/* ===== å®æ—¶æ‰«ç  ===== */
let track = null;
let flash = false;

Quagga.init({
    inputStream:{
        name:"Live",
        type:"LiveStream",
        target: scannerContainer,
        constraints:{facingMode:"environment", width:{ideal:1280}, height:{ideal:720}}
    },
    decoder:{readers:["code_128_reader"]},
    locate:true
}, err=>{
    if(err){ console.error(err); result.innerText="æ— æ³•å¯åŠ¨æ‘„åƒå¤´"; return; }
    const videoEl = scannerContainer.querySelector("video");
    Quagga.start();
    if(videoEl.srcObject) track = videoEl.srcObject.getVideoTracks()[0];
});

Quagga.onDetected(res=>{
    if(res.codeResult?.code) processScanResult(res.codeResult.code);
});

/* ===== é—ªå…‰ç¯ ===== */
flashBtn.onclick = async () => {
    if(!track){ alert("æ‘„åƒå¤´æœªå°±ç»ª"); return; }
    const cap = track.getCapabilities();
    if(!cap.torch){ alert("æ­¤è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯"); return; }
    flash = !flash;
    await track.applyConstraints({advanced:[{torch:flash}]});
    flashBtn.innerText = flash ? "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå¼€å¯ï¼‰" : "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰";
};

/* ===== ç›¸å†Œæ‰«ç  ===== */
let cropper = null;
const reader = new ZXing.BrowserBarcodeReader();

galleryBtn.onclick = () => imageInput.click();

imageInput.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    scannerContainer.style.display="none";
    imageLayer.style.display="block";
    scanImage.src = URL.createObjectURL(f);
    scanImage.onload = () => {
        const ratio = scanImage.naturalWidth / scanImage.naturalHeight;
        cropper = new Cropper(scanImage, {viewMode:1, dragMode:"move", autoCropArea:0.8, aspectRatio: ratio>1.2 ? 4/1 : NaN});
    };
};

confirmImageScan.onclick = () => {
    if(!cropper) return;
    const canvas = cropper.getCroppedCanvas();
    reader.decodeFromImage(undefined, canvas.toDataURL())
        .then(r => processScanResult(r.text))
        .catch(()=>result.innerText="æœªè¯†åˆ«åˆ°æ¸…æ™°æ¡ç ");
};

cancelImageScan.onclick = () => {
    cropper?.destroy();
    imageLayer.style.display="none";
    scannerContainer.style.display="block";
};

/* ===== æˆåŠŸè·³è½¬ ===== */
function handleSuccess(code){
    beep.currentTime=0; beep.play().catch(()=>{});
    result.innerText = "è¯†åˆ«æˆåŠŸï¼š" + code;
    const appURL = `appsheet://app?appId=${appId}#view=${view}&row=${encodeURIComponent(code)}`;
    const webURL = `https://www.appsheet.com/start/${appId}#view=${view}&row=${encodeURIComponent(code)}`;
    const iframe = document.createElement("iframe");
    iframe.style.display="none";
    iframe.src = appURL;
    document.body.appendChild(iframe);
    setTimeout(()=>location.href = webURL, 1200);
}
</script>

</body>
</html>
