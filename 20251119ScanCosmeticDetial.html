<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmetics Scanner - æ‰¹æ¬¡è¯¦æƒ…</title>
<meta name="robots" content="noindex, nofollow">

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
body{
    margin:0;
    background:linear-gradient(180deg,#fff5f8,#ffeaf1);
    color:#d63384;
    font-family:"Segoe UI","Microsoft YaHei",sans-serif;
    text-align:center;
}
h2{margin-top:16px;}

#scanner-container{
    position:relative;
    width:90vw;
    height:45vh;
    margin:20px auto;
    border:2px solid rgba(255,105,180,.4);
    border-radius:12px;
    overflow:hidden;
}

video{
    width:100%;
    height:100%;
    object-fit:cover;
}

.corner{
    position:absolute;
    width:28px;height:28px;
    border:3px solid #ff69b4;
}
.top-left{top:0;left:0;border-right:none;border-bottom:none;}
.top-right{top:0;right:0;border-left:none;border-bottom:none;}
.bottom-left{bottom:0;left:0;border-right:none;border-top:none;}
.bottom-right{bottom:0;right:0;border-left:none;border-top:none;}

.center-line{
    position:absolute;
    top:50%;
    left:0;
    width:100%;
    height:2px;
    background:#ff69b4;
    transform:translateY(-50%);
}

button{
    padding:10px 18px;
    font-size:16px;
    background:#d63384;
    color:white;
    border:none;
    border-radius:8px;
    margin:6px;
}

#result{
    margin:14px;
    font-weight:600;
}

#toast{
    position:fixed;
    top:16px;
    right:16px;
    background:rgba(214,51,132,.9);
    color:white;
    padding:8px 12px;
    border-radius:8px;
    opacity:0;
    transition:opacity .4s;
    z-index:9999;
}
</style>
</head>

<body>

<h2>æ‰¹æ¬¡è¯¦æƒ…æ‰«ç </h2>

<div id="scanner-container">
    <video></video>
    <div class="corner top-left"></div>
    <div class="corner top-right"></div>
    <div class="corner bottom-left"></div>
    <div class="corner bottom-right"></div>
    <div class="center-line"></div>
</div>

<div id="result">ç­‰å¾…æ‰«æä¸­...</div>

<button id="flash-btn">ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰</button>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<div id="toast"></div>

<script>
/* ===== AppSheet ===== */
const appId = "c2893944-c589-4385-833c-17a86cc10826";
const view  = "Batchs_Detail";

/* ===== è°ƒè¯• ===== */
const DEBUG = new URLSearchParams(location.search).get("debug")==="1";
const toast = document.getElementById("toast");
function showToast(t){
    if(!DEBUG) return;
    toast.innerText=t;
    toast.style.opacity=1;
    setTimeout(()=>toast.style.opacity=0,1200);
}

/* ===== æ‰«ç è§„åˆ™ ===== */
const REG = /^[A-Z0-9-]+$/;
const LEN = 8;
const CONFIRM = 2;
const THROTTLE = 30000;

let lastCode=null;
let stableCount=0;
let lastSuccess=0;
let frozen=false;

/* ===== DOM ===== */
const scanner = document.getElementById("scanner-container");
const flashBtn = document.getElementById("flash-btn");
const result = document.getElementById("result");
const beep = document.getElementById("beep");

/* ===== æ ¡éªŒ ===== */
function process(code){
    if(frozen) return;

    if(!REG.test(code)) return showToast("éæ³•å­—ç¬¦");
    if(code.length !== LEN) return showToast("é•¿åº¦ä¸ç¬¦");

    if(code === lastCode){
        stableCount++;
    }else{
        lastCode = code;
        stableCount = 1;
    }

    if(stableCount < CONFIRM){
        return showToast("ç¨³å®šä¸­ " + stableCount + "/" + CONFIRM);
    }

    if(Date.now() - lastSuccess < THROTTLE){
        return showToast("èŠ‚æµä¸­");
    }

    frozen = true;
    lastSuccess = Date.now();
    success(code);
}

/* ===== æ‘„åƒå¤´åˆå§‹åŒ– ===== */
let track=null, flash=false;

Quagga.init({
    inputStream:{
        type:"LiveStream",
        target:scanner,
        constraints:{ facingMode:"environment" },
        area:{   // ğŸ‘ˆ é™å®šä¸­é—´æ‰«æåŒºåŸŸ
            top:"35%",
            right:"15%",
            left:"15%",
            bottom:"35%"
        }
    },
    decoder:{ readers:["code_128_reader"] },
    locate:true
}, err=>{
    if(err){
        result.innerText="æ— æ³•å¯åŠ¨æ‘„åƒå¤´";
        return;
    }
    Quagga.start();

    const video = scanner.querySelector("video");
    if(video.srcObject){
        track = video.srcObject.getVideoTracks()[0];
    }
});

/* ===== æ‰«æç›‘å¬ ===== */
Quagga.onDetected(r=>{
    if(r.codeResult?.code){
        process(r.codeResult.code);
    }
});

/* ===== é—ªå…‰ç¯ ===== */
flashBtn.onclick = async ()=>{
    if(!track) return alert("æ‘„åƒå¤´æœªå°±ç»ª");
    const cap = track.getCapabilities();
    if(!cap.torch) return alert("è¯¥è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯");

    flash = !flash;
    await track.applyConstraints({ advanced:[{ torch:flash }] });
    flashBtn.innerText = flash ? "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå¼€å¯ï¼‰" : "ğŸ”¦ é—ªå…‰ç¯ï¼ˆå…³é—­ï¼‰";
};

/* ===== æˆåŠŸå¤„ç† ===== */
function success(code){
    beep.play().catch(()=>{});
    result.innerText = "è¯†åˆ«æˆåŠŸï¼š" + code;

    // â¸ å†»ç»“ 0.5 ç§’
    Quagga.stop();

    const appURL = `appsheet://app?appId=${appId}#view=${view}&row=${encodeURIComponent(code)}`;
    const webURL = `https://www.appsheet.com/start/${appId}#view=${view}&row=${encodeURIComponent(code)}`;

    const iframe = document.createElement("iframe");
    iframe.style.display="none";
    iframe.src = appURL;
    document.body.appendChild(iframe);

    setTimeout(()=>location.href = webURL, 500);
}
</script>

</body>
</html>
